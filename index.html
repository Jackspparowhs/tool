<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map — PirateRuler</title>
<meta name="description" content="Clean full-screen map by PirateRuler — no API keys required." />
<meta name="theme-color" content="#0b2b20" />
<link rel="icon" href="https://pirateruler.com/static/pr-logo.png" type="image/png">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  :root{
    --bg: #071225;
    --green-a: #2fa64f;   /* primary green */
    --green-b: #0f8f3f;
    --muted: #9fb3a6;
    --ui-text: #e9f1ff;
  }

  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:var(--ui-text)}
  a{color:inherit}

  /* tiny unobtrusive header (fixed) */
  header{
    position:fixed; top:10px; left:12px; z-index:1400;
    display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:12px;
    background:rgba(255,255,255,0.03); backdrop-filter: blur(6px);
    box-shadow:0 10px 30px rgba(2,8,20,0.45);
  }
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--green-a),var(--green-b));display:flex;align-items:center;justify-content:center;font-weight:900;color:white}
  .hdr-text{display:flex;flex-direction:column;line-height:1}
  .hdr-title{font-weight:800;font-size:14px;color:rgba(255,255,255,0.96)}
  .hdr-sub{font-size:11px;color:var(--muted);margin-top:2px}

  /* control column on top-right */
  .controls {
    position:fixed; top:14px; right:14px; z-index:1400; display:flex; flex-direction:column; gap:10px;
  }
  .btn {
    display:inline-flex; align-items:center; justify-content:center;
    min-width:84px; padding:10px 12px; border-radius:12px;
    background:linear-gradient(90deg,var(--green-a),var(--green-b));
    color:white; font-weight:800; border:0; box-shadow: 0 8px 24px rgba(9,30,66,0.18);
    cursor:pointer;
  }
  .btn.ghost { background: rgba(255,255,255,0.06); color:var(--ui-text); border:0; box-shadow:none; font-weight:700; }

  .icon-btn {
    width:48px; height:48px; border-radius:12px; background:rgba(255,255,255,0.04);
    display:flex; align-items:center; justify-content:center; color:white; border:0; cursor:pointer;
  }

  /* map fills viewport */
  #map { position:fixed; inset:0; z-index:0; }

  /* small attribution bottom-left */
  .attribution {
    position:fixed; left:12px; bottom:12px; z-index:1400;
    background: rgba(0,0,0,0.45); color:#dfeef0; font-size:12px; padding:6px 8px; border-radius:8px;
  }

  /* Leaflet popup style for readability */
  .leaflet-popup-content-wrapper { background:#fff; color:#06203a; border-radius:10px; }
  .leaflet-popup-tip { background:#fff; }

  /* responsiveness */
  @media(max-width:720px){
    header{ top:8px; left:8px }
    .controls{ top:10px; right:8px }
    .btn { min-width:68px; padding:8px 10px }
  }
</style>
</head>
<body>
  <!-- tiny header -->
  <header aria-hidden="true">
    <div class="logo">PR</div>
    <div class="hdr-text">
      <div class="hdr-title">Map</div>
      <div class="hdr-sub">PirateRuler</div>
    </div>
  </header>

  <!-- controls -->
  <div class="controls" role="toolbar" aria-label="Map controls">
    <button id="locateBtn" class="btn" title="Locate me">Locate</button>
    <button id="searchBtn" class="btn ghost" title="Search">Search</button>
    <button id="clearBtn" class="icon-btn" title="Clear markers">✖</button>
  </div>

  <!-- the map -->
  <div id="map" aria-label="Map"></div>

  <!-- small attribution -->
  <div class="attribution">PirateRuler.com</div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Create the map with a friendly default view
    const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([22.0, 78.0], 4);

    // Use CartoDB Positron tiles (no auth required) — clean, human-friendly
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    // subtle scale control bottom-left
    L.control.scale({ position: 'bottomleft', imperial: false }).addTo(map);

    // marker layer for pins
    const markerLayer = L.layerGroup().addTo(map);

    // UI elements
    const locateBtn = document.getElementById('locateBtn');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');

    // place marker helper
    function placeMarker(lat, lon, label){
      markerLayer.clearLayers();
      const m = L.marker([lat, lon], { riseOnHover: true }).addTo(markerLayer);
      const content = `<div style="font-weight:900">${escapeHtml(label || 'Pinned location')}</div>
                       <div style="font-size:13px;color:#334">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>`;
      m.bindPopup(content).openPopup();
    }

    // click on map to pin
    map.on('click', (e) => {
      placeMarker(e.latlng.lat, e.latlng.lng, 'Pinned location');
    });

    // locate me button
    locateBtn.addEventListener('click', () => {
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      locateBtn.disabled = true; locateBtn.textContent = 'Locating…';
      navigator.geolocation.getCurrentPosition(pos => {
        locateBtn.disabled = false; locateBtn.textContent = 'Locate';
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        placeMarker(lat, lon, 'You are here');
        map.setView([lat, lon], 13);
      }, err => {
        locateBtn.disabled = false; locateBtn.textContent = 'Locate';
        alert('Location error: ' + (err.message || err.code));
      }, { enableHighAccuracy: true, timeout: 10000 });
    });

    // search button opens a lightweight prompt (minimal UI to keep page clean)
    searchBtn.addEventListener('click', async () => {
      const q = prompt('Search place, address, or airport: (type and press OK)');
      if(!q) return;
      try {
        const results = await nominatimSearch(q);
        if(!results || results.length === 0){ alert('No results'); return; }
        const first = results[0];
        const lat = parseFloat(first.lat), lon = parseFloat(first.lon);
        placeMarker(lat, lon, first.display_name || q);
        map.setView([lat, lon], 13);
      } catch(e) {
        console.warn('Search error', e);
        alert('Search failed');
      }
    });

    // clear markers
    clearBtn.addEventListener('click', () => markerLayer.clearLayers());

    // Nominatim search helper (public)
    async function nominatimSearch(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=6`;
      const r = await fetch(url, { headers: { 'Accept-Language': 'en' } });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return await r.json();
    }

    // small escape helper
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    // ensure correct rendering on mobile
    window.requestAnimationFrame(()=> setTimeout(()=> map.invalidateSize(), 60));
  </script>
</body>
</html>
