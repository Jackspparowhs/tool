<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Speed Test â€” PirateRuler.com</title>
<link rel="icon" href="https://pirateruler.com/static/pr-logo.png" type="image/png">
<meta name="description" content="Speed Test by PirateRuler â€” client-only demo: live download/upload throughput, ping, per-second updates." />
<style>
  :root{
    --bg:#f2f4f8; --card:#ffffff; --muted:#6b7480; --accent:#0A84FF; --accent-2:#7b4bff; --text:#071225;
    --radius:14px; --shadow:0 10px 30px rgba(2,8,20,0.06);
  }
  html.dark { --bg:#071225; --card:linear-gradient(180deg,#071225,#061028); --muted:#98a7bf; --text:#e9f1ff; --accent:#32d74b; --accent-2:#2fa64f; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:16px;min-height:100vh}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:900;box-shadow:var(--shadow)}
  .titlebox{line-height:1}
  .titlebox .t1{font-weight:900;font-size:18px}
  .titlebox .t2{font-size:13px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(10,132,255,0.12)}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text);box-shadow:none;font-weight:700;padding:8px 12px}
  .theme-btn{width:44px;height:44px;border-radius:999px;border:0;background:var(--card);box-shadow:var(--shadow);cursor:pointer}
  .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:var(--shadow);display:flex;gap:20px;align-items:center;flex-wrap:wrap}
  .big {flex:1;min-width:260px}
  .stat {text-align:center;padding:18px;border-radius:12px;background:rgba(0,0,0,0.02)}
  .stat .num{font-weight:900;font-size:40px;color:var(--accent)}
  .stat .lbl{color:var(--muted);margin-top:8px}
  .side {width:300px;min-width:220px}
  .controls-row{display:flex;gap:10px;align-items:center;margin-top:14px}
  .small {font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff;padding:10px 12px;border-radius:12px;border:0;cursor:pointer}
  .small.stop{background:#ececec;color:var(--text)}
  .mini {font-size:13px;color:var(--muted)}
  .footer {margin-top:12px;color:var(--muted);font-size:13px}
  .offcanvas{position:fixed;right:12px;top:12px;width:320px;max-width:92vw;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,0.12);transform:translateX(120%);transition:transform .28s;z-index:9999}
  .offcanvas.open{transform:translateX(0)}
  .offcanvas h3{margin:0 0 8px 0}
  .menu-item{padding:12px;border-radius:10px;background:rgba(0,0,0,0.03);margin-bottom:8px;font-weight:800}
  @media(max-width:900px){
    .card{flex-direction:column}
    .side{width:100%}
    .offcanvas{right:8px;left:8px;top:auto;bottom:12px;transform:translateY(120%);transition:transform .28s}
    .offcanvas.open{transform:translateY(0)}
  }
  .live-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
  .live-box{flex:1;padding:12px;border-radius:12px;background:rgba(0,0,0,0.02);text-align:center}
  .live-box .v{font-weight:900;font-size:20px}
  .graph{height:84px;background:linear-gradient(180deg,rgba(10,132,255,0.04),transparent);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PR</div>
        <div class="titlebox">
          <div class="t1">Speed Test</div>
          <div class="t2">by PirateRuler.com</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <button id="openMenu" class="btn ghost" title="Menu" aria-expanded="false">Menu</button>
        <button id="toggleTheme" class="theme-btn" title="Toggle theme">ðŸŒ“</button>
      </div>
    </header>

    <section class="card" aria-label="speed card">
      <div class="big">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="min-width:220px">
            <div style="font-size:13px;color:var(--muted);font-weight:800">Quick Internet Speed Check</div>
            <div style="color:var(--muted);margin-top:6px">Live throughput numbers update every second. For best accuracy use your own CORS-enabled server with large files.</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="startBtn" class="small">Start Test</button>
            <button id="stopBtn" class="small stop" disabled>Stop</button>
          </div>
        </div>

        <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap">
          <div class="stat" style="flex:1;min-width:220px">
            <div class="num" id="currentThrough">0.0 Mbps</div>
            <div class="lbl">Current throughput</div>
          </div>

          <div class="stat" style="flex:1;min-width:220px">
            <div style="display:flex;gap:10px;align-items:center;justify-content:center">
              <div style="text-align:center;margin-right:8px">
                <div style="font-weight:900;font-size:26px;color:var(--accent)" id="dlAvg">0.0</div>
                <div style="color:var(--muted)">Download Mbps</div>
              </div>
              <div style="text-align:center;margin-left:8px">
                <div style="font-weight:900;font-size:26px;color:var(--accent-2)" id="ulAvg">0.0</div>
                <div style="color:var(--muted)">Upload Mbps</div>
              </div>
            </div>
          </div>

          <div class="stat" style="flex:1;min-width:220px">
            <div style="font-weight:900;font-size:22px" id="pingVal">-- ms</div>
            <div style="color:var(--muted)">Ping</div>
            <div style="margin-top:10px;color:var(--muted);font-size:13px" id="serverInfo">Server: public demo</div>
          </div>
        </div>

        <div class="live-row" aria-hidden="false">
          <div class="live-box">
            <div class="v" id="dlLive">DL: 0.0 Mbps</div>
            <div class="mini">Live download throughput (per-second)</div>
          </div>
          <div class="live-box">
            <div class="v" id="ulLive">UL: 0.0 Mbps</div>
            <div class="mini">Live upload throughput (per-second)</div>
          </div>
        </div>

        <div class="footer">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div style="color:var(--muted)">Tip: close other heavy apps and prefer wired for best accuracy.</div>
            <div style="color:var(--muted);font-size:13px" id="resultNote">Client-only demo</div>
          </div>
        </div>
      </div>

      <aside class="side">
        <div style="padding:12px;border-radius:12px;background:rgba(0,0,0,0.02)">
          <div style="font-weight:900">Live graph</div>
          <div class="graph" id="graphArea">(live graph placeholder)</div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="copyBtn" class="btn ghost" style="flex:1">Copy results</button>
            <button id="resetBtn" class="btn ghost" style="flex:1">Reset</button>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:13px">Results update every second. This is a browser-only demo â€” for production use your own endpoints for accurate results.</div>
        </div>
      </aside>
    </section>

    <div style="height:18px"></div>
    <footer style="text-align:center;color:var(--muted)">Â© <span id="year"></span> PirateRuler â€” Speed Test</footer>
  </div>

  <div id="menu" class="offcanvas" role="dialog" aria-hidden="true">
    <h3>Menu</h3>
    <div class="menu-item" onclick="startQuick()">Start Test</div>
    <div class="menu-item" onclick="showAbout()">About</div>
    <div class="menu-item" onclick="showPrivacy()">Privacy</div>
    <div class="menu-item" onclick="showContact()">Contact</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="closeMenuBtn" class="btn ghost" style="flex:1">Close</button>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
$('year').textContent = new Date().getFullYear();

/* theme */
const doc = document.documentElement;
const saved = localStorage.getItem('pr-theme') || 'light';
if(saved === 'dark') doc.classList.add('dark');
$('toggleTheme').addEventListener('click', ()=>{
  if(doc.classList.contains('dark')){ doc.classList.remove('dark'); localStorage.setItem('pr-theme','light'); }
  else { doc.classList.add('dark'); localStorage.setItem('pr-theme','dark'); }
});

/* menu */
const menu = $('menu');
$('openMenu').addEventListener('click', ()=> {
  const open = menu.classList.toggle('open');
  $('openMenu').setAttribute('aria-expanded', String(open));
});
$('closeMenuBtn').addEventListener('click', ()=> menu.classList.remove('open'));
function startQuick(){ menu.classList.remove('open'); startTest(); }
function showAbout(){ alert('Speed Test by PirateRuler â€” client-only demo.'); }
function showPrivacy(){ alert('Privacy: Runs client-side. No server storage by default.'); }
function showContact(){ alert('Contact: PirateRuler.com'); }

/* ---------- improved speed test logic ---------- */

/*
  Changes made:
  - Immediate small probe to produce a fast initial estimate
  - Parallel progressive download streams (4) to saturate better
  - Upload measured with XMLHttpRequest + progress events to show live upload
  - UI updates every 500ms for snappy feel
  - Smoothing via simple moving average for stable numbers
*/

let running = false;
let dlBytes = 0, dlStart = 0;
let dlSamples = [], ulSamples = [];
let pingMs = null;
let abortControllers = [];
let uiTimer = null;
let dlLastBytes = 0;
let UI_INTERVAL = 500; // 500ms updates for snappier UI

// public demo files (these are CORS-enabled public hosts; for production host your own)
const DOWNLOAD_URLS = [
  'https://speed.hetzner.de/100MB.bin',  // big
  'https://speed.hetzner.de/10MB.bin'    // fallback smaller
];
const PARALLEL_DOWNLOADS = 4;
const DL_RUN_MS = 12000; // 12s of downloads
const UPLOAD_SIZE_MB = 8; // upload blob ~8MB for measurable upload streaming
const UPLOAD_URL = 'https://httpbin.org/post'; // public echo (CORS)

/* helper conversions */
function bytesToMbps(bytes, seconds){ return (bytes * 8) / (1024*1024) / Math.max(seconds, 0.000001); }
function setText(id, txt){ if($(id)) $(id).textContent = txt; }

/* ping first quickly (small fetch) */
async function measurePing(){
  try {
    const t0 = performance.now();
    await fetch('https://httpbin.org/get?cachebust=' + Math.random(), {cache:'no-store', mode:'cors'});
    const t1 = performance.now();
    pingMs = Math.round(t1 - t0);
  } catch(e){ pingMs = null; }
  setText('pingVal', pingMs ? `${pingMs} ms` : '-- ms');
}

/* small fast probe: fetch a small byte-range to get immediate throughput */
async function smallProbe(url){
  try {
    const controller = new AbortController();
    abortControllers.push(controller);
    // try requesting a small range (first ~200KB) to get a fast initial delta
    const headers = new Headers();
    headers.set('Range','bytes=0-200000');
    const res = await fetch(url + '?r=' + Math.random(), { method:'GET', headers, signal: controller.signal, cache:'no-store', mode:'cors' });
    if(!res.ok) return 0;
    const reader = res.body.getReader();
    let probeBytes = 0;
    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      probeBytes += value.byteLength;
      dlBytes += value.byteLength;
      // return early after some bytes so UI can update
      if(probeBytes >= 180000) break;
    }
    try{ controller.abort(); }catch(e){}
    return probeBytes;
  } catch(e){
    return 0;
  }
}

/* stream download: progressive fetch + reader */
async function streamDownload(url){
  const controller = new AbortController();
  abortControllers.push(controller);
  try {
    const res = await fetch(url + '?r=' + Math.random(), { method:'GET', signal: controller.signal, cache:'no-store', mode:'cors' });
    if(!res.ok || !res.body) return;
    const reader = res.body.getReader();
    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      dlBytes += value.byteLength;
      // slight yielding
      // (we don't await here so loop continues quickly)
    }
  } catch(e){
    // ignore errors (CORS, abort)
  }
}

/* upload measured via XMLHttpRequest to get onprogress events */
function startUploadWithProgress(){
  return new Promise((resolve) => {
    try {
      // build blob of size UPLOAD_SIZE_MB
      const chunk = new Uint8Array(1024*1024).fill(0x61);
      const parts = [];
      for(let i=0;i<UPLOAD_SIZE_MB;i++) parts.push(chunk);
      const blob = new Blob(parts, {type: 'application/octet-stream'});

      const xhr = new XMLHttpRequest();
      xhr.open('POST', UPLOAD_URL + '?r=' + Math.random());
      xhr.timeout = 30000;
      let lastLoaded = 0;
      let lastTime = performance.now();
      const samples = [];

      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const now = performance.now();
          const deltaBytes = e.loaded - lastLoaded;
          const deltaSeconds = (now - lastTime)/1000;
          if(deltaSeconds > 0){
            const mbps = bytesToMbps(deltaBytes, deltaSeconds);
            samples.push(mbps);
            // update live UL speed immediately
            setText('ulLive', 'UL: ' + mbps.toFixed(2) + ' Mbps');
          }
          lastLoaded = e.loaded;
          lastTime = now;
        }
      };
      xhr.onload = function(){
        // compute average from samples
        const avg = samples.length ? (samples.reduce((a,b)=>a+b,0)/samples.length) : 0;
        resolve(avg);
      };
      xhr.onerror = function(){ resolve(0); };
      xhr.ontimeout = function(){ resolve(0); };
      xhr.send(blob);
    } catch(e){ resolve(0); }
  });
}

/* start UI updater (smoother, 500ms) */
function startUiLoop(){
  if(uiTimer) clearInterval(uiTimer);
  let smoothingWindow = 6; // keep last N samples for smoothing
  let dlMoving = [];
  uiTimer = setInterval(()=>{
    // compute overall elapsed seconds since dlStart
    const now = performance.now();
    const elapsed = (now - dlStart)/1000;
    const totalDl = dlBytes;
    const overallMbps = bytesToMbps(totalDl, Math.max(elapsed,0.000001));
    // compute per-interval speed using delta bytes since last tick
    const deltaBytes = totalDl - (dlLastBytes || 0);
    const msInterval = UI_INTERVAL;
    const instantMbps = bytesToMbps(deltaBytes, Math.max(msInterval/1000, 0.000001));
    dlLastBytes = totalDl;

    // smoothing
    dlMoving.push(instantMbps);
    if(dlMoving.length > smoothingWindow) dlMoving.shift();
    const smooth = dlMoving.reduce((a,b)=>a+b,0)/dlMoving.length;

    // push sample into dlSamples every second (approx)
    dlSamples.push(overallMbps);

    setText('currentThrough', smooth.toFixed(2) + ' Mbps');
    setText('dlLive', 'DL: ' + overallMbps.toFixed(2) + ' Mbps');
    const dlAvgVal = dlSamples.length ? (dlSamples.reduce((a,b)=>a+b,0)/dlSamples.length) : overallMbps;
    setText('dlAvg', dlAvgVal.toFixed(2));

    // UL: we use ulSamples populated by upload function
    const ulAvgVal = ulSamples.length ? (ulSamples.reduce((a,b)=>a+b,0)/ulSamples.length) : parseFloat($('ulLive').textContent.replace(/[^\d.]/g,'')) || 0;
    setText('ulAvg', ulAvgVal.toFixed(2));

    setText('pingVal', pingMs ? `${pingMs} ms` : '-- ms');
    // graph placeholder
    $('graphArea').textContent = Math.round(smooth) + ' Mbps';
  }, UI_INTERVAL);
}
function stopUiLoop(){ if(uiTimer){ clearInterval(uiTimer); uiTimer=null; } }

/* start test driver */
async function startTest(){
  if(running) return;
  running = true;
  $('startBtn').disabled = true;
  $('stopBtn').disabled = false;
  dlBytes = 0; dlSamples=[]; ulSamples=[]; dlStart = performance.now(); dlLastBytes = 0;
  setText('currentThrough','0.0 Mbps'); setText('dlLive','DL: 0.0 Mbps'); setText('ulLive','UL: 0.0 Mbps'); setText('dlAvg','0.0'); setText('ulAvg','0.0');
  setText('resultNote','Running test â€” client-only demo');

  // initial quick ping and small probe to show a fast number
  await measurePing();
  // small probe try each download URL until one works
  let probeSuccess = false;
  for(const url of DOWNLOAD_URLS){
    const p = await smallProbe(url);
    if(p > 0){ probeSuccess = true; break; }
  }
  // start UI loop (immediate)
  startUiLoop();

  // start parallel streaming downloads for DL_RUN_MS
  const startTime = performance.now();
  abortControllers = [];
  const dlPromises = [];
  for(let i=0;i<PARALLEL_DOWNLOADS;i++){
    // pick first url (big) and stream until time window ends
    dlPromises.push((async ()=>{
      while(running && (performance.now() - startTime) < DL_RUN_MS){
        await streamDownload(DOWNLOAD_URLS[0]);
        // small delay to allow other tasks and avoid tight loop
        await new Promise(r=>setTimeout(r, 80));
      }
    })());
  }

  // in parallel, schedule upload tests halfway through
  const uploader = (async ()=>{
    // wait a short bit so download has started
    await new Promise(r=>setTimeout(r, 1200));
    // attempt two upload runs, recording averages
    for(let i=0;i<2 && running;i++){
      const avg = await startUploadWithProgress();
      if(avg) ulSamples.push(avg);
      // short wait between uploads
      await new Promise(r=>setTimeout(r, 300));
    }
  })();

  // wait for downloads to finish or stop
  await Promise.race([
    Promise.all(dlPromises),
    new Promise(r=> setTimeout(r, DL_RUN_MS + 2000))
  ]).catch(()=>{});

  // ensure uploader completes
  await uploader.catch(()=>{});

  // done
  running = false;
  // abort any outstanding controllers
  try{ abortControllers.forEach(c=>c.abort()); }catch(e){}
  stopUiLoop();

  // compute final averages
  const dlAvg = dlSamples.length ? (dlSamples.reduce((a,b)=>a+b,0)/dlSamples.length) : bytesToMbps(dlBytes, Math.max((performance.now()-dlStart)/1000, 0.000001));
  const ulAvg = ulSamples.length ? (ulSamples.reduce((a,b)=>a+b,0)/ulSamples.length) : 0;
  setText('dlAvg', dlAvg.toFixed(2));
  setText('ulAvg', ulAvg.toFixed(2));
  setText('currentThrough', '0.0 Mbps');
  setText('resultNote', 'Demo complete â€” results are approximate (client-only)');
  $('startBtn').disabled = false;
  $('stopBtn').disabled = true;
}

/* stop */
function stopTest(){
  running = false;
  try{ abortControllers.forEach(c=>c.abort()); }catch(e){}
  stopUiLoop();
  $('startBtn').disabled = false;
  $('stopBtn').disabled = true;
  setText('resultNote','Test stopped');
}

/* UI interactions */
$('startBtn').addEventListener('click', ()=> startTest());
$('stopBtn').addEventListener('click', ()=> stopTest());
$('resetBtn').addEventListener('click', ()=>{
  dlBytes = 0; dlSamples=[]; ulSamples=[]; setText('dlAvg','0.0'); setText('ulAvg','0.0'); setText('currentThrough','0.0 Mbps'); setText('dlLive','DL: 0.0 Mbps'); setText('ulLive','UL: 0.0 Mbps'); setText('pingVal','-- ms'); $('graphArea').textContent='(live graph placeholder)';
});
$('copyBtn').addEventListener('click', ()=>{
  const txt = `Speed Test results:
  Download (avg): ${$('dlAvg').textContent} Mbps
  Upload (avg): ${$('ulAvg').textContent} Mbps
  Ping: ${$('pingVal').textContent}
  Source: PirateRuler client-only demo`;
  navigator.clipboard?.writeText(txt).then(()=> alert('Results copied')).catch(()=> alert('Copy failed'));
});

/* keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 's') startTest();
  if(e.key.toLowerCase() === 'x') stopTest();
});
</script>
</body>
</html>
