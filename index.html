<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Speed Test â€” PirateRuler.com</title>
<link rel="icon" href="https://pirateruler.com/static/pr-logo.png" type="image/png">
<meta name="description" content="Speed Test by PirateRuler â€” client-only demo: live download/upload throughput, ping, per-second updates." />
<style>
  :root{
    --bg:#f2f4f8; --card:#ffffff; --muted:#6b7480; --accent:#0A84FF; --accent-2:#7b4bff; --text:#071225;
    --radius:14px; --shadow:0 10px 30px rgba(2,8,20,0.06);
  }
  html.dark { --bg:#071225; --card:linear-gradient(180deg,#071225,#061028); --muted:#98a7bf; --text:#e9f1ff; --accent:#32d74b; --accent-2:#2fa64f; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:16px;min-height:100vh}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:900;box-shadow:var(--shadow)}
  .titlebox{line-height:1}
  .titlebox .t1{font-weight:900;font-size:18px}
  .titlebox .t2{font-size:13px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(10,132,255,0.12)}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text);box-shadow:none;font-weight:700;padding:8px 12px}
  .theme-btn{width:44px;height:44px;border-radius:999px;border:0;background:var(--card);box-shadow:var(--shadow);cursor:pointer}
  /* main card */
  .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:var(--shadow);display:flex;gap:20px;align-items:center;flex-wrap:wrap}
  .big {flex:1;min-width:260px}
  .stat {text-align:center;padding:18px;border-radius:12px;background:rgba(0,0,0,0.02)}
  .stat .num{font-weight:900;font-size:40px;color:var(--accent)}
  .stat .lbl{color:var(--muted);margin-top:8px}
  .side {width:300px;min-width:220px}
  .controls-row{display:flex;gap:10px;align-items:center;margin-top:14px}
  .small {font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff;padding:10px 12px;border-radius:12px;border:0;cursor:pointer}
  .small.stop{background:#ececec;color:var(--text)}
  .mini {font-size:13px;color:var(--muted)}
  .footer {margin-top:12px;color:var(--muted);font-size:13px}
  /* offcanvas menu (right) */
  .offcanvas{position:fixed;right:12px;top:12px;width:320px;max-width:92vw;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,0.12);transform:translateX(120%);transition:transform .28s;z-index:9999}
  .offcanvas.open{transform:translateX(0)}
  .offcanvas h3{margin:0 0 8px 0}
  .menu-item{padding:12px;border-radius:10px;background:rgba(0,0,0,0.03);margin-bottom:8px;font-weight:800}
  /* responsive */
  @media(max-width:900px){
    .card{flex-direction:column}
    .side{width:100%}
    .offcanvas{right:8px;left:8px;top:auto;bottom:12px;transform:translateY(120%);transition:transform .28s}
    .offcanvas.open{transform:translateY(0)}
  }
  /* small readout styles */
  .live-row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
  .live-box{flex:1;padding:12px;border-radius:12px;background:rgba(0,0,0,0.02);text-align:center}
  .live-box .v{font-weight:900;font-size:20px}
  .graph{height:84px;background:linear-gradient(180deg,rgba(10,132,255,0.04),transparent);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PR</div>
        <div class="titlebox">
          <div class="t1">Speed Test</div>
          <div class="t2">by PirateRuler.com</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <button id="openMenu" class="btn ghost" title="Menu" aria-expanded="false">Menu</button>
        <button id="toggleTheme" class="theme-btn" title="Toggle theme">ðŸŒ“</button>
      </div>
    </header>

    <section class="card" aria-label="speed card">
      <div class="big">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="min-width:220px">
            <div style="font-size:13px;color:var(--muted);font-weight:800">Quick Internet Speed Check</div>
            <div style="color:var(--muted);margin-top:6px">Live throughput numbers update every second. For best accuracy use your own CORS-enabled server with large files.</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="startBtn" class="small">Start Test</button>
            <button id="stopBtn" class="small stop" disabled>Stop</button>
          </div>
        </div>

        <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap">
          <div class="stat" style="flex:1;min-width:220px">
            <div class="num" id="currentThrough">0.0 Mbps</div>
            <div class="lbl">Current throughput</div>
          </div>

          <div class="stat" style="flex:1;min-width:220px">
            <div style="display:flex;gap:10px;align-items:center;justify-content:center">
              <div style="text-align:center;margin-right:8px">
                <div style="font-weight:900;font-size:26px;color:var(--accent)" id="dlAvg">0.0</div>
                <div style="color:var(--muted)">Download Mbps</div>
              </div>
              <div style="text-align:center;margin-left:8px">
                <div style="font-weight:900;font-size:26px;color:var(--accent-2)" id="ulAvg">0.0</div>
                <div style="color:var(--muted)">Upload Mbps</div>
              </div>
            </div>
          </div>

          <div class="stat" style="flex:1;min-width:220px">
            <div style="font-weight:900;font-size:22px" id="pingVal">-- ms</div>
            <div style="color:var(--muted)">Ping</div>
            <div style="margin-top:10px;color:var(--muted);font-size:13px" id="serverInfo">Server: public demo</div>
          </div>
        </div>

        <div class="live-row" aria-hidden="false">
          <div class="live-box">
            <div class="v" id="dlLive">DL: 0.0 Mbps</div>
            <div class="mini">Live download throughput (per-second)</div>
          </div>
          <div class="live-box">
            <div class="v" id="ulLive">UL: 0.0 Mbps</div>
            <div class="mini">Live upload throughput (per-second)</div>
          </div>
        </div>

        <div class="footer">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div style="color:var(--muted)">Tip: close other heavy apps and prefer wired for best accuracy.</div>
            <div style="color:var(--muted);font-size:13px" id="resultNote">Client-only demo</div>
          </div>
        </div>
      </div>

      <aside class="side">
        <div style="padding:12px;border-radius:12px;background:rgba(0,0,0,0.02)">
          <div style="font-weight:900">Live graph</div>
          <div class="graph" id="graphArea">(live graph placeholder)</div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="copyBtn" class="btn ghost" style="flex:1">Copy results</button>
            <button id="resetBtn" class="btn ghost" style="flex:1">Reset</button>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:13px">Results update every second. This is a browser-only demo â€” for production use your own endpoints for accurate results.</div>
        </div>
      </aside>
    </section>

    <div style="height:18px"></div>
    <footer style="text-align:center;color:var(--muted)">Â© <span id="year"></span> PirateRuler â€” Speed Test</footer>
  </div>

  <!-- Offcanvas menu -->
  <div id="menu" class="offcanvas" role="dialog" aria-hidden="true">
    <h3>Menu</h3>
    <div class="menu-item" onclick="startQuick()">Start Test</div>
    <div class="menu-item" onclick="showAbout()">About</div>
    <div class="menu-item" onclick="showPrivacy()">Privacy</div>
    <div class="menu-item" onclick="showContact()">Contact</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="closeMenuBtn" class="btn ghost" style="flex:1">Close</button>
    </div>
  </div>

<script>
/* ---------- small helpers ---------- */
const u = s => document.getElementById(s);
u('year').textContent = new Date().getFullYear();

/* Theme toggle */
const doc = document.documentElement;
const saved = localStorage.getItem('pr-theme') || 'light';
if(saved === 'dark') doc.classList.add('dark');
else doc.classList.remove('dark');

u('toggleTheme').addEventListener('click', () => {
  if(doc.classList.contains('dark')){ doc.classList.remove('dark'); localStorage.setItem('pr-theme','light'); }
  else { doc.classList.add('dark'); localStorage.setItem('pr-theme','dark'); }
});

/* Menu open/close */
const menu = u('menu');
u('openMenu').addEventListener('click', () => {
  const open = menu.classList.toggle('open');
  u('openMenu').setAttribute('aria-expanded', String(open));
});
u('closeMenuBtn').addEventListener('click', ()=> menu.classList.remove('open'));

/* small menu helper functions (placeholders) */
function startQuick(){ menu.classList.remove('open'); startTest(); }
function showAbout(){ alert('Speed Test by PirateRuler â€” client-only demo.'); }
function showPrivacy(){ alert('Privacy: Runs client-side. No server storage by default.'); }
function showContact(){ alert('Contact: PirateRuler.com'); }

/* ---------- Speed test logic (client-only demo) ---------- */

/*
 Approach:
 - Measure ping with a small HEAD fetch to https://httpbin.org/get
 - Download test: progressive streaming of a large file (Hetzner speed test file).
   We stream it using fetch + ReadableStream, count bytes as they arrive and compute per-second throughput.
 - Upload test: create a blob of known size and POST to https://httpbin.org/post, measure time until upload finishes (this gives approximate upload)
 - Live per-second stats show in UI.
 NOTE: For production use you should host large CORS-enabled files on a server you control.
*/

let running = false;
let dlBytes = 0, dlStart = 0, dlLast = 0;
let ulBytes = 0, ulStart = 0;
let dlSamples = [], ulSamples = [];
let pingMs = null;
let dlController = null; // abort controller

const DOWNLOAD_URL = 'https://speed.hetzner.de/100MB.bin'; // public demo file (adjust as needed)
const PARALLEL_DOWNLOADS = 2; // parallel streams for better measurement on fast links
const UPLOAD_ECHO = 'https://httpbin.org/post'; // public demo echo endpoint (CORS-enabled)

function setText(id, txt){ if(u(id)) u(id).textContent = txt; }
function toMbps(bytes, seconds){ return (bytes * 8) / (1024*1024) / Math.max(seconds, 0.000001); }

/* ping */
async function measurePing(){
  try{
    const t0 = performance.now();
    const res = await fetch('https://httpbin.org/get?nocache=' + Math.random(), {cache:'no-store', mode:'cors'});
    const t1 = performance.now();
    if(res.ok) pingMs = Math.round(t1 - t0);
    else pingMs = null;
  }catch(e){ pingMs = null; }
  setText('pingVal', pingMs ? `${pingMs} ms` : '-- ms');
}

/* download worker: streams file and counts bytes */
async function streamDownload(signal){
  try {
    const res = await fetch(DOWNLOAD_URL + '?r=' + Math.random(), { method: 'GET', signal, cache:'no-store', mode:'cors' });
    if(!res.body) return 0;
    const reader = res.body.getReader();
    let total = 0;
    while(true){
      const { done, value } = await reader.read();
      if(done) break;
      total += value.byteLength;
      // update global counters for live UI
      dlBytes += value.byteLength;
    }
    return total;
  } catch(e){
    // aborted or network error
    return 0;
  }
}

/* start download test */
async function startDownloadTest(){
  dlBytes = 0; dlStart = performance.now(); dlLast = dlStart; dlSamples = [];
  dlController = new AbortController();
  const promises = [];
  for(let i=0;i<PARALLEL_DOWNLOADS;i++){
    promises.push(streamDownload(dlController.signal));
  }
  // run all parallel, but we keep reading dlBytes live in interval
  await Promise.all(promises);
}

/* upload test (approx): create a large blob and POST it */
async function startUploadTest(){
  // create a blob ~5MB for upload demo. On fast links increase size.
  const size = 5 * 1024 * 1024; // 5 MB
  const chunk = new Uint8Array(1024*1024).fill(0x61); // 1MB chunk 'a's
  const parts = [];
  let remaining = size;
  while(remaining > 0){
    parts.push(chunk.slice(0, Math.min(remaining, chunk.length)));
    remaining -= chunk.length;
  }
  const blob = new Blob(parts, { type: 'application/octet-stream' });
  const start = performance.now();
  try{
    const res = await fetch(UPLOAD_ECHO + '?r=' + Math.random(), {
      method: 'POST',
      body: blob,
      mode: 'cors',
      cache:'no-store',
    });
    const end = performance.now();
    const elapsed = (end - start) / 1000;
    // bytes uploaded = blob.size
    ulBytes += blob.size;
    // record sample
    const mbps = toMbps(blob.size, elapsed);
    ulSamples.push(mbps);
  } catch(e){
    // ignore
  }
}

/* UI update loop */
let uiInterval = null;
function startUiLoop(){
  if(uiInterval) clearInterval(uiInterval);
  uiInterval = setInterval(()=>{
    // compute per-second download throughput since last tick
    const now = performance.now();
    const secondsTotal = (now - dlStart)/1000;
    const bytesSinceStart = dlBytes;
    const dlMbps = toMbps(bytesSinceStart, Math.max(secondsTotal, 0.000001));
    // approximate current per-second by taking delta since last sample
    const lastDeltaBytes = bytesSinceStart - (dlLastBytes || 0);
    const deltaSeconds = (now - (dlLast || now))/1000;
    const currentMbps = toMbps(lastDeltaBytes, Math.max(deltaSeconds, 0.000001));
    dlLast = now; dlLastBytes = bytesSinceStart;
    setText('currentThrough', currentMbps.toFixed(2) + ' Mbps');
    setText('dlLive', 'DL: ' + dlMbps.toFixed(2) + ' Mbps');
    setText('dlAvg', dlSamples.length ? ( (dlSamples.reduce((a,b)=>a+b,0))/dlSamples.length ).toFixed(2) : dlMbps.toFixed(2));

    // upload live (we update ulLive from ulSamples)
    const ulAvgVal = ulSamples.length ? (ulSamples.reduce((a,b)=>a+b,0)/ulSamples.length) : 0;
    setText('ulLive', 'UL: ' + ulAvgVal.toFixed(2) + ' Mbps');
    setText('ulAvg', ulAvgVal.toFixed(2));

    setText('serverInfo', 'Server: public demo (httpbin / hetzner)');
    setText('pingVal', pingMs ? `${pingMs} ms` : '-- ms');

    // optional: simple graph text placeholder
    const graph = u('graphArea');
    if(graph) graph.textContent = `${Math.round(currentMbps)} Mbps`;
  }, 1000);
}

function stopUiLoop(){
  if(uiInterval) { clearInterval(uiInterval); uiInterval = null; }
}

/* driver */
async function startTest(){
  if(running) return;
  running = true;
  u('startBtn').disabled = true;
  u('stopBtn').disabled = false;
  setText('currentThrough','0.0 Mbps');
  setText('dlLive','DL: 0.0 Mbps'); setText('ulLive','UL: 0.0 Mbps');
  dlSamples=[]; ulSamples=[]; ulBytes=0; dlBytes=0; dlStart=performance.now(); dlLast = dlStart; dlLastBytes = 0;
  await measurePing();
  startUiLoop();

  // start downloads in background - run for up to X seconds or until stopped
  const DL_DURATION = 12 * 1000; // 12s
  const startTime = performance.now();
  try{
    // run downloads (parallel) for duration but read continuously
    dlController = new AbortController();
    const streams = [];
    for(let i=0;i<PARALLEL_DOWNLOADS;i++){
      streams.push((async ()=>{
        // repeated fetches until DL_DURATION
        while(running && (performance.now() - startTime) < DL_DURATION){
          await streamDownload(dlController.signal);
          // record sample every iteration roughly
          const sec = (performance.now() - dlStart) / 1000;
          const mbps = toMbps(dlBytes, sec);
          dlSamples.push(mbps);
          // small delay to avoid hammering in very fast loops
          await new Promise(r=>setTimeout(r, 200));
        }
      })());
    }
    await Promise.all(streams);
  } catch(e){
    // ignore
  }

  // after downloads, do a couple of upload tests
  if(running){
    for(let i=0;i<2;i++){
      await startUploadTest();
    }
  }

  // finalize
  running = false;
  if(dlController) { try{ dlController.abort(); }catch(e){} dlController = null; }
  stopUiLoop();
  // compute averages:
  const dlAvg = dlSamples.length ? (dlSamples.reduce((a,b)=>a+b,0)/dlSamples.length) : toMbps(dlBytes, Math.max((performance.now()-dlStart)/1000,0.000001));
  const ulAvg = ulSamples.length ? (ulSamples.reduce((a,b)=>a+b,0)/ulSamples.length) : 0;
  setText('dlAvg', dlAvg.toFixed(2));
  setText('ulAvg', ulAvg.toFixed(2));
  setText('currentThrough', '0.0 Mbps');
  u('startBtn').disabled = false;
  u('stopBtn').disabled = true;
  u('resultNote').textContent = 'Demo complete â€” results are approximate (client-only)';
}

/* stop */
function stopTest(){
  running = false;
  if(dlController){ try{ dlController.abort(); }catch(e){} dlController = null; }
  stopUiLoop();
  u('startBtn').disabled = false;
  u('stopBtn').disabled = true;
}

/* copy results (simple summary) */
u('copyBtn').addEventListener('click', ()=>{
  const txt = `Speed Test results:\nDownload (avg): ${u('dlAvg').textContent} Mbps\nUpload (avg): ${u('ulAvg').textContent} Mbps\nPing: ${u('pingVal').textContent}\nSource: PirateRuler client-only demo`;
  navigator.clipboard?.writeText(txt).then(()=> alert('Results copied')).catch(()=> alert('Copy failed'));
});

/* start/stop buttons */
u('startBtn').addEventListener('click', ()=> startTest());
u('stopBtn').addEventListener('click', ()=> stopTest());
u('resetBtn').addEventListener('click', ()=>{
  dlBytes=0; ulBytes=0; dlSamples=[]; ulSamples=[]; setText('dlAvg','0.0'); setText('ulAvg','0.0'); setText('dlLive','DL: 0.0 Mbps'); setText('ulLive','UL: 0.0 Mbps'); setText('currentThrough','0.0 Mbps'); setText('pingVal','-- ms');
});

/* small keyboard shortcut: S = start */
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 's') startTest();
  if(e.key.toLowerCase() === 'x') stopTest();
});
</script>
</body>
</html>
