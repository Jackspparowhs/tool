<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Image Color Finder — PirateRuler</title>
<style>
  :root{
    --bg:#f3f7fb; --card:#fff; --text:#07212a; --muted:#66727b;
    --accent:#6b7dff; --radius:14px;
  }
  html.dark { --bg:#071225; --card:#061028; --text:#e9f1ff; --muted:#98a7bf; --accent:#5ab3ff; }
  body{background:linear-gradient(180deg,var(--bg),#e9f6ff);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);margin:0;padding:20px;}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .logo{display:flex;gap:12px;align-items:center}
  .logo .mark{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#0bb3ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
  .title{font-weight:800;font-size:18px}
  .controls{display:flex;gap:10px;align-items:center}
  button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#0bb3ff);color:white}
  .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(3,12,30,0.06);border:1px solid rgba(0,0,0,0.04)}
  .uploader{display:flex;gap:12px;align-items:center}
  .drop{flex:1;min-height:180px;border-radius:12px;border:2px dashed rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;padding:12px;text-align:center;color:var(--muted)}
  .row{display:flex;gap:16px;margin-top:12px;align-items:flex-start}
  canvas{max-width:100%;border-radius:12px;display:block}
  .palette{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .sw{width:72px;height:72px;border-radius:8px;display:flex;align-items:flex-end;justify-content:center;padding:6px;color:white;font-weight:800;box-shadow:0 6px 16px rgba(3,12,30,0.12)}
  .color-info{font-size:12px;background:rgba(0,0,0,0.18);padding:6px;border-radius:6px}
  .muted{color:var(--muted)}
  .picker{margin-top:8px;display:flex;gap:8px;align-items:center}
  .small{font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  input[type="range"]{width:160px}
  @media(max-width:900px){ .row{flex-direction:column} .sw{width:56px;height:56px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="mark" aria-hidden="true">PR</div>
        <div>
          <div class="title">Image Color Finder</div>
          <div class="muted small">Extract colors from images — client-side only</div>
        </div>
      </div>
      <div class="controls">
        <button id="themeBtn" class="btn-primary">Toggle Theme</button>
      </div>
    </header>

    <div class="card uploader" aria-live="polite">
      <div id="dropZone" class="drop">
        <div>
          <div style="font-weight:800">Drop an image here or click to choose</div>
          <div class="muted small">PNG, JPG, WEBP. Everything runs in your browser.</div>
          <div style="margin-top:8px" class="muted small">Click the image to pick a pixel color.</div>
        </div>
      </div>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <div class="row">
      <div style="flex:1">
        <div class="card" id="imageCard">
          <canvas id="imageCanvas" style="display:block"></canvas>
          <div class="picker muted small">Click on image to sample color</div>
          <div id="pixelInfo" class="picker" aria-hidden="true"></div>
        </div>
      </div>

      <aside style="width:360px;max-width:40%">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:900">Palette</div>
            <div class="muted small">Colors extracted from image</div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <label class="small">Colors:</label>
            <input id="kRange" type="range" min="2" max="12" value="6" />
            <div id="kValue" class="muted small">6</div>
          </div>

          <div class="palette" id="palette"></div>

          <div class="actions">
            <button class="btn-primary" id="extractBtn">Extract Palette</button>
            <button id="exportJSON" class="btn">Export JSON</button>
            <button id="downloadPng" class="btn">Download Pal PNG</button>
            <button id="clearBtn" class="btn">Clear</button>
          </div>

          <div style="margin-top:12px" class="muted small">Tip: reduce k for fewer colors. Sampling is optimized for speed.</div>
        </div>
      </aside>
    </div>
  </div>

<script>
(function(){
  const drop = document.getElementById('dropZone');
  const fileIn = document.getElementById('fileInput');
  const canvas = document.getElementById('imageCanvas');
  const ctx = canvas.getContext('2d', {willReadFrequently:true});
  const paletteEl = document.getElementById('palette');
  const extractBtn = document.getElementById('extractBtn');
  const pixelInfo = document.getElementById('pixelInfo');
  const kRange = document.getElementById('kRange');
  const kValue = document.getElementById('kValue');
  const exportJSON = document.getElementById('exportJSON');
  const downloadPng = document.getElementById('downloadPng');
  const clearBtn = document.getElementById('clearBtn');
  const themeBtn = document.getElementById('themeBtn');

  let img = new Image();
  let imgLoaded = false;
  let currentPalette = [];
  let lastImageData = null;

  // theme
  function toggleTheme(){ document.documentElement.classList.toggle('dark'); }
  themeBtn.addEventListener('click', toggleTheme);

  // drag/drop
  drop.addEventListener('click', ()=> fileIn.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor='rgba(0,0,0,0.10)'; });
  drop.addEventListener('dragleave', e=>{ e.preventDefault(); drop.style.borderColor=''; });
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.borderColor=''; const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handleFile(f); });
  fileIn.addEventListener('change', e=> { if(e.target.files[0]) handleFile(e.target.files[0]); });

  function handleFile(file){
    if(!file.type.startsWith('image/')) return alert('Please pick an image file.');
    const url = URL.createObjectURL(file);
    loadImage(url);
  }

  function loadImage(src){
    imgLoaded = false;
    img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      // fit to canvas with max width
      const maxW = 900;
      const maxH = 700;
      let w = img.naturalWidth, h = img.naturalHeight;
      const ratio = Math.min(1, maxW/w, maxH/h);
      w = Math.round(w * ratio); h = Math.round(h * ratio);
      canvas.width = w; canvas.height = h;
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
      imgLoaded = true;
      lastImageData = ctx.getImageData(0,0,w,h);
      extractPalette(); // auto-extract
    };
    img.onerror = ()=> alert('Failed to load image. Try a different image.');
    img.src = src;
  }

  // clicking image to sample pixel
  canvas.addEventListener('click', e=>{
    if(!imgLoaded) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
    const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
    const px = ctx.getImageData(x, y, 1, 1).data;
    showPixel(px);
  });

  function showPixel([r,g,b,a]){
    const hex = rgbToHex(r,g,b);
    pixelInfo.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <div style="width:56px;height:36px;border-radius:8px;background:${hex};box-shadow:0 8px 18px rgba(0,0,0,0.08)"></div>
      <div>
        <div style="font-weight:800">${hex}</div>
        <div class="muted small">${r}, ${g}, ${b} • alpha ${Math.round(a/255*100)}%</div>
        <div style="margin-top:6px"><button class="btn" onclick="navigator.clipboard.writeText('${hex}')">Copy HEX</button></div>
      </div>
    </div>`;
    pixelInfo.setAttribute('aria-hidden','false');
  }

  // extract palette (k-means)
  extractBtn.addEventListener('click', extractPalette);
  kRange.addEventListener('input', ()=> kValue.textContent = kRange.value);

  function extractPalette(){
    if(!imgLoaded) return alert('Load an image first.');
    // sample pixels for speed
    const sampleStep = Math.max(1, Math.round( (canvas.width*canvas.height) / 35000 )); // adapt sampling
    const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    const pixels = [];
    for(let y=0; y<canvas.height; y+=sampleStep){
      for(let x=0; x<canvas.width; x+=sampleStep){
        const i = (y*canvas.width + x)*4;
        const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
        if(a < 125) continue; // ignore transparent-ish
        // ignore near-white or near-black? maybe not
        pixels.push([r,g,b]);
      }
    }
    if(pixels.length === 0) return alert('No pixels to sample (image may be fully transparent).');

    const k = parseInt(kRange.value,10) || 6;
    // run k-means
    const {centroids, counts} = kmeans(pixels, k, {maxIter:25});
    // sort by counts desc
    const items = centroids.map((c,i)=>({color:c, count:counts[i]})).sort((a,b)=>b.count-a.count);
    currentPalette = items.map(it=>({hex: rgbToHex(...it.color), rgb: it.color, p: Math.round((it.count / pixels.length)*100)}));
    renderPalette();
  }

  function renderPalette(){
    paletteEl.innerHTML = '';
    currentPalette.forEach((c, idx)=>{
      const sw = document.createElement('div');
      sw.className = 'sw';
      sw.style.background = c.hex;
      sw.innerHTML = `<div style="text-align:center;width:100%">
        <div style="font-size:12px">${c.hex}</div>
        <div style="font-size:11px;opacity:0.9">${c.p}%</div>
        <div style="margin-top:6px"><button class="btn" onclick="navigator.clipboard.writeText('${c.hex}')">Copy</button></div>
      </div>`;
      paletteEl.appendChild(sw);
    });
  }

  // basic k-means implementation (Euclidean, RGB)
  function kmeans(samples, k, opts={}){
    // samples: array of [r,g,b]
    const maxIter = opts.maxIter || 20;
    // init centroids by random sampling
    const centroids = [];
    const used = new Set();
    while(centroids.length < k){
      const idx = Math.floor(Math.random()*samples.length);
      if(used.has(idx)) continue;
      used.add(idx);
      centroids.push(samples[idx].slice());
    }
    const counts = new Array(k).fill(0);
    const assignments = new Array(samples.length).fill(-1);
    for(let iter=0; iter<maxIter; iter++){
      let changed = false;
      // assign
      for(let i=0;i<samples.length;i++){
        const s = samples[i];
        let best = 0, bestd = dist2(s, centroids[0]);
        for(let j=1;j<k;j++){
          const d = dist2(s, centroids[j]);
          if(d < bestd){ bestd = d; best = j; }
        }
        if(assignments[i] !== best){ assignments[i] = best; changed = true; }
      }
      // recompute centroids
      const sums = new Array(k).fill(0).map(()=>[0,0,0]);
      const cnts = new Array(k).fill(0);
      for(let i=0;i<samples.length;i++){
        const a = assignments[i];
        const s = samples[i];
        sums[a][0] += s[0]; sums[a][1] += s[1]; sums[a][2] += s[2];
        cnts[a] ++;
      }
      for(let j=0;j<k;j++){
        if(cnts[j] === 0) {
          // reinit empty centroid randomly
          const idx = Math.floor(Math.random()*samples.length);
          centroids[j] = samples[idx].slice();
        } else {
          centroids[j] = [ Math.round(sums[j][0]/cnts[j]), Math.round(sums[j][1]/cnts[j]), Math.round(sums[j][2]/cnts[j]) ];
        }
        counts[j] = cnts[j];
      }
      if(!changed) break;
    }
    return {centroids, counts};
  }
  function dist2(a,b){ const dr=a[0]-b[0], dg=a[1]-b[1], db=a[2]-b[2]; return dr*dr+dg*dg+db*db; }

  // helpers
  function componentToHex(c){ const s = c.toString(16); return s.length==1 ? '0'+s : s; }
  function rgbToHex(r,g,b){ return '#'+componentToHex(r)+componentToHex(g)+componentToHex(b); }

  // export JSON
  exportJSON.addEventListener('click', ()=>{
    if(!currentPalette.length) return alert('No palette to export.');
    const data = {palette: currentPalette, generatedAt: new Date().toISOString()};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='palette.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // download palette png
  downloadPng.addEventListener('click', ()=>{
    if(!currentPalette.length) return alert('No palette to download.');
    const sw = Math.max(64, Math.floor(360/currentPalette.length));
    const w = sw * currentPalette.length;
    const h = 120;
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const g = c.getContext('2d');
    currentPalette.forEach((p,i)=>{
      g.fillStyle = p.hex; g.fillRect(i*sw, 0, sw, h);
      g.fillStyle = invertColor(p.hex); g.font='14px Arial'; g.textAlign='center';
      g.fillText(p.hex, i*sw + sw/2, h - 10);
    });
    const url = c.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = 'palette.png'; document.body.appendChild(a); a.click(); a.remove();
  });

  // clear
  clearBtn.addEventListener('click', ()=> {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    canvas.width = canvas.height = 0;
    imgLoaded = false;
    paletteEl.innerHTML = '';
    pixelInfo.innerHTML = '';
    currentPalette = [];
  });

  // invert color for contrast (simple)
  function invertColor(hex){
    if(hex[0] === '#') hex = hex.slice(1);
    const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return (yiq >= 128) ? '#111' : '#fff';
  }

  // expose one tiny helper so buttons inside sw can copy
  window.navigatorClipboard = {
    copy: (s)=> navigator.clipboard.writeText(s)
  };

  // keyboard sample: press E to extract
  document.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='e') extractPalette(); });

  // make functions accessible from inline onclick (copy)
  window.navigator.clipboard = window.navigator.clipboard || { writeText: (t)=> Promise.resolve() };

})();
</script>
</body>
</html>
